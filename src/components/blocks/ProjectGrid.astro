---
import { getCollection } from 'astro:content';
import { useTranslations, type Language } from '@/i18n/utils';
import ProjectCard from '@/components/blocks/ProjectCard.astro';
import { ArrowRight } from 'lucide-react';

export interface Props {
  limit?: number;
  moreHref?: string;
  showTitle?: boolean;
}

const { limit, moreHref, showTitle = false } = Astro.props;

// Detectar idioma actual
const currentLang: Language = (Astro.currentLocale as Language) || 'es';
const t = useTranslations(currentLang);

// Obtener proyectos filtrados por idioma y ordenados
const allProjects = await getCollection('projects');
const projects = allProjects
  .filter((p) => p.data.lang === currentLang)
  .sort((a, b) => {
    // Destacados primero
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;

    // Luego por prioridad
    const priorityA = a.data.priority ?? 5;
    const priorityB = b.data.priority ?? 5;
    if (priorityA !== priorityB) return priorityB - priorityA;

    // Finalmente por fecha
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  })
  .slice(0, limit || allProjects.length);
---

<div class="mx-auto max-w-6xl px-6 py-12">
  {
    showTitle && (
      <div class="mb-12 text-center">
        <h2 class="mb-4 text-3xl font-bold text-foreground md:text-4xl">{t('work.featured')}</h2>
        <p class="mx-auto max-w-2xl text-lg text-muted-foreground">{t('hero.description')}</p>
      </div>
    )
  }

  {
    projects.length > 0 ? (
      <>
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {projects.map((project) => (
            <ProjectCard project={project} currentLang={currentLang} />
          ))}
        </div>

        {moreHref && (
          <div class="mt-12 text-center">
            <a
              href={moreHref}
              class="inline-flex items-center gap-2 rounded-lg bg-primary px-6 py-3 font-medium text-primary-foreground transition-colors hover:bg-primary/90"
            >
              {t('work.viewAll')}
              <ArrowRight size={16} />
            </a>
          </div>
        )}
      </>
    ) : (
      <p class="text-center text-muted-foreground">{t('work.noProjects')}</p>
    )
  }
</div>
