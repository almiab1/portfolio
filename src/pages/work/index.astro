---
import Layout from '@/layouts/BaseLayout.astro';
import { getProjectsByLang } from '@/lib/i18n-content';
import { useTranslations } from '@/i18n/utils';
import ProjectCard from '@/components/blocks/ProjectCard.astro';
import ProjectFilter from '@/components/blocks/ProjectFilter';

const projects = await getProjectsByLang('es');
const t = useTranslations('es');

// Ordenar proyectos: destacados primero, luego por priority, luego por fecha
const sortedProjects = projects.sort((a, b) => {
  // Destacados primero
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;

  // Luego por prioridad
  const priorityA = a.data.priority ?? 5;
  const priorityB = b.data.priority ?? 5;
  if (priorityA !== priorityB) return priorityB - priorityA;

  // Finalmente por fecha
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

// Extraer todos los tags Ãºnicos
const allTags = [...new Set(sortedProjects.flatMap((p) => p.data.tags || []))].sort();
---

<Layout title={t('work.title')} description={t('hero.description')}>
  <main class="mx-auto max-w-7xl px-6 pt-24 pb-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="mb-4 text-4xl font-bold text-foreground md:text-5xl">
        {t('nav.work')}
      </h1>
      <p class="max-w-2xl text-lg text-muted-foreground">
        {t('hero.description')}
      </p>
    </div>

    <!-- Filtro de proyectos -->
    {
      allTags.length > 0 && (
        <ProjectFilter
          client:load
          allTags={allTags}
          totalProjects={sortedProjects.length}
          translations={{
            filterBy: t('work.filterBy'),
            allProjects: t('work.allProjects'),
            clearFilters: t('work.clearFilters'),
            noResults: t('work.noResults'),
            searchPlaceholder: t('work.searchPlaceholder'),
            searchLabel: t('work.searchLabel'),
          }}
        />
      )
    }

    <!-- Projects Grid -->
    {
      sortedProjects.length > 0 ? (
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {sortedProjects.map((project) => (
            <ProjectCard project={project} currentLang="es" />
          ))}
        </div>
      ) : (
        <p class="py-12 text-center text-muted-foreground">{t('work.noProjects')}</p>
      )
    }
  </main>
</Layout>
